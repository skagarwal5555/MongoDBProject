
//create index on geolocation and category
db.drivers.createIndex( { currentGeoLocation: "2dsphere" , "vehicles.category":1} );


//Find the drivers and car category within 5 km
db.drivers.aggregate( 
      {
		$geoNear: 
		{
			near: { type: "Point", coordinates: [ 88.0521, 27.1751 ] },
		    maxDistance: 5000,
			spherical: true,
			distanceField: "dist.calculated"
		}
	  },
	  {$unwind: "$vehicles"},
	  {$match: { "vehicles.isActiveUsed" : true }},
      {
		$project: 
		{
			"name":1,
			"vehicles.category":1
		}
	  }
    ).pretty();
	

//Find the drivers within 5 KM with Suv Category
db.drivers.aggregate( 
      {
		$geoNear: 
		{
			near: { type: "Point", coordinates: [ 88.0521, 27.1751 ] },
		    maxDistance: 5000,
			spherical: true,
			distanceField: "dist.calculated"
		}
	  },
	  {$unwind: "$vehicles"},
	  {$match: { "vehicles.isActiveUsed" : true , "vehicles.category":"Suv"}},
      {
		$project: 
		{
			"name":1,
			"vehicles.category":1
		}
	  }
    ).pretty();

//Find driver with id =1 and having tripId 103 , show the driver rating
db.drivers.aggregate( 
	{$unwind: "$trips"},
	{$match: { "_id":1, "trips.tripId" : 103 }},
	{
	  $project: 
	  {
		  "name":1,"rating":1, "trips.tripId":1, "trips.driverRating":1
	  }
	}
  ).pretty();


//update driver rating for a trip provided by the user
db.drivers.update({ "_id":1, "trips.tripId" : 103 }, { $set : { "trips.$.driverRating" : 4 }});

//calculate total rating of driver
db.drivers.aggregate( [
   { $match: { _id: 1 } },
   {
     $set: {
        rating: { $avg: "$trips.driverRating" }
     }
   },
      {
		$project: 
		{
			"name":1,
			"rating":1
		}
	  }
]).pretty();


//Delete a Saved Address
db.drivers.update({"_id":1}, { $pull: { "savedAddress" : { "zipCode":79108 } }} );

db.drivers.find({ "_id":1 } , { "name":1, "savedAddress" :1}).pretty();

//Insert a new saved Address 
db.drivers.update({"_id":1}, { $push: { "savedAddress" : {
            "addr1":"6565 Lock Avenue",
            "addr2":"Apt 306",
            "city":"Amarillo",
            "state":"Texas",
            "Country":"USA",
            "zipCode":79107
         } }} );
		 
db.drivers.find({ "_id":1 } , { "name":1, "savedAddress" :1}).pretty();

//update address for a driver
db.drivers.update({ "_id":1, "savedAddress.zipCode" : 79107 }, { $set : { "savedAddress.$.addr2" : "Apt 102" }});


db.drivers.find({ "_id":1 } , { "name":1, "savedAddress" :1}).pretty();


db.drivers.find({ "_id":1 } , { "name":1, "defaultAddress" :1}).pretty();

//update default address
db.drivers.update({"_id":1}, { $set: { "defaultAddress" : {
            "addr1":"6565 Lock Avenue",
            "addr2":"Apt 306",
            "city":"Amarillo",
            "state":"Texas",
            "Country":"USA",
            "zipCode":79107
         } } });
		 
db.drivers.find({ "_id":1 } , { "name":1, "defaultAddress" :1}).pretty();

db.drivers.find({ "_id":2 } , { "name":1, "vehicles" :1}).pretty();

//Delete a vehicles
db.drivers.update({"_id":2}, { $pull: { "vehicles" : { "licensePlateNumber":"KLL5060" } }} );
		 

//Insert a new  vehicles 
db.drivers.update({"_id":2}, { $push: { "vehicles" : {
             "licensePlateNumber":"KLL5061",
            "color":"Black",
            "category":"Luxury",
            "isActiveUsed":false
         } }} );	

//update address for a driver
db.drivers.update({ "_id":2, "vehicles.licensePlateNumber" : "KLL5061" }, { $set : { "vehicles.$.color" : "Jet Black" }});

		 


